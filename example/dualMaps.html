<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Add a third party vector tile source</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.js'></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
	<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.css' rel='stylesheet' />
    <link rel="stylesheet" type="text/css" href="mapStyle.css">
</head>
<body>

<div id="container">
  <div class="split left">
	<div id="map" style="background-color: rgb(202,210,212)">
		<div align="center">
			<select disabled="true">
				<option value="2009">2009</option>
				<option value="2010">2010</option>
				<option value="2011" selected="true">2011</option>
				<option value="2012">2012</option>
				<option value="2013">2013</option>
				<option value="2014">2014</option>
			</select>
			<select onchange="changeMonth()" id="month">
				<option value="01">Jan</option>
				<option value="02">Feb</option>
				<option value="03">Mar</option>
				<option value="04">Apr</option>
				<option value="05">May</option>
				<option value="06">June</option>
				<option value="07">July</option>
				<option value="08">Aug</option>
				<option value="09">Sept</option>
				<option value="10">Oct</option>
				<option value="11">Nov</option>
				<option value="12">Dec</option>
			</select>
		</div>
	</div>
	</div>
	<div id="divider"></div>
	<div class="split right">
		<div id="map2" style="background-color: rgb(202,210,212)"></div>
	</div>
</div>
<script>
var currentMonth;
var map, map2;
window.onload = function() { start(); }

window.onresize = function() {
  setWindowSize();
}

function setWindowSize() {
  console.log("----", window.innerWidth, window.innerHeight)
  var width = (window.innerWidth - 6) / 2;
  d3.select("#map").style("width", width + "px")
  d3.select("#map2").style("width", width + "px")
}
setWindowSize();

function start(){
	var sPageURL = decodeURIComponent(window.location.search.substring(1)),
		sURLVariables = sPageURL.split('&'),
		sParameterName,
		i,
		month;
		
	for (i=0; i<sURLVariables.length;i++){
		sParameterName = sURLVariables[i].split('=');
		if(sParameterName[0] === "month")
			month = sParameterName[1] === undefined ? true : sParameterName[1];
	}
	if(month === undefined)
		window.location = "http://localhost:31338/dualMaps.html?month=01";
		
	document.getElementById("month").value = month;
	currentMonth = month;
	mapboxgl.accessToken = 'pk.eyJ1IjoiYXN0cmVsa2UiLCJhIjoiY2pjNnI1azltMWxoMDJ3bnl5MDRvMDlqbSJ9.DiXgHhxTTdOrKM4huxjgfQ';
	map = new mapboxgl.Map({
		container: 'map',
		style: 'mapbox://styles/mapbox/light-v9',
		zoom: 0,
		maxzoom: 14,
		center: [0, 0]
	});
	map2 = new mapboxgl.Map({
		container: 'map2',
		style: 'mapbox://styles/mapbox/light-v9',
		zoom: 0,
		maxzoom: 8,
		center: [0, 0]
	});

	map.on('load', function() {
		// Add Mapillary sequence layer.
		// https://www.mapillary.com/developer/tiles-documentation/#sequence-layer
		map.addSource("voyages",{
			"type": "vector",
			"tiles": ["http://localhost:31338/Tiles/Zone19_2011_01/{z}/{x}/{y}.mvt"],
			"minzoom": 0,
			"maxzoom": 14
		});
		map.addLayer({
			"id": "mapillary",
			"type": "line",
			"source": "voyages",
			"source-layer": "layer0",
			"layout": {
				"line-cap": "round",
				"line-join": "round"
			},
			"paint": {
				"line-color": "rgb(53, 175, 109)",
				"line-width": ["get","weight"]
			}
		});
		map.addLayer({
			"id": "mapillary-hover",
			"type": "line",
			"source": "voyages",
			"source-layer": "layer0",
			"layout": {
				"line-cap": "round",
				"line-join": "round"
			},
			"paint": {
				"line-color": "rgb(255, 255, 0)",
				"line-width": ["get","weight"],
				"line-opacity": 0
			}
		});
		/*
			Hover over trajectory on left-hand map 
			to highlight all trajectories on the right-hand side
			containing one or more of the same voyage Ids. 
		*/
		map.on("mousemove", "mapillary-hover", function(e){
			activateHover(e);
		});
		map.on("mouseleave", "mapillary-hover", function(){
			deactivateHover();
		});
	});
	
	map2.on('load', function() {
		// Add Mapillary sequence layer.
		// https://www.mapillary.com/developer/tiles-documentation/#sequence-layer
		map2.addSource("voyages2",{
			"type": "vector",
			"tiles": ["http://localhost:31338/Tiles/Zone19_2011_01/{z}/{x}/{y}.mvt"],
			"minzoom": 0,
			"maxzoom": 8
		});
		map2.addLayer({
			"id": "mapillary2",
			"type": "line",
			"source": "voyages2",
			"source-layer": "layer0",
			"layout": {
				"line-cap": "round",
				"line-join": "round"
			},
			"paint": {
				"line-color": "rgb(53, 175, 109)",
				"line-width": ["get","weight"]
			}
		});
		map2.addLayer({
			"id": "mapillary2-hover",
			"type": "line",
			"source": "voyages2",
			"source-layer": "layer0",
			"layout": {
				"line-cap": "round",
				"line-join": "round"
			},
			"paint": {
				"line-color": "rgb(255, 255, 0)",
				"line-width": ["get","weight"],
				"line-opacity": 0
			}
		});
		map2.on("mousemove", "mapillary2-hover", function(e){
			activateHover(e);
		});
		map2.on("mouseleave", "mapillary2-hover", function(){
			deactivateHover();
		});
	});
	map.addControl(new mapboxgl.NavigationControl());
	map2.addControl(new mapboxgl.NavigationControl());
}

function changeMonth(){
	var month, r = confirm("Do you want to change the month of the data?");
	if(r == true){
		month = document.getElementById("month").value;
		window.location = "http://localhost:31338/dualMaps.html?month="+month;
	} else {
		document.getElementById("month").value = currentMonth;
	}
}

function activateHover(e){
	var i,j,index;
	map.getCanvas().style.cursor = "pointer";
	var idStr = e.features[0].properties.voyageIDs;
	idStr = idStr.substring(0,idStr.length);
	var ids = idStr.split(",");			
	//Get trajectories on left-hand side with one or more of the same voyage Ids as the one hovered
	var features = map.queryRenderedFeatures({layers:['mapillary-hover']});
	var selectedNames = [];
	for(j=0; j<features.length; j++){
		for(i=0; i< ids.length; i++){
			index = features[j].properties.voyageIDs.indexOf(ids[i]);
			if(index > -1){
				selectedNames.push(features[j].properties.name);
				break;
			}
		}
	};	
	///Get trajectories on right-hand side with one of the same voyage Ids as the one hovered
	var features2 = map2.queryRenderedFeatures({layers:['mapillary2-hover']});
	var selectedNames2 = [];
	for(j=0; j<features2.length; j++){
		for(i=0; i< ids.length; i++){
			index = features2[j].properties.voyageIDs.indexOf(ids[i]);
			if(index > -1){
				selectedNames2.push(features2[j].properties.name);
				break;
			}
		}
	};
	//Highlight Trajectories
	map.setFilter("mapillary-hover", ["in","name"].concat(selectedNames));
	map.setPaintProperty('mapillary-hover', 'line-opacity',1);
	map2.setFilter("mapillary2-hover", ["in","name"].concat(selectedNames2));
	map2.setPaintProperty('mapillary2-hover', 'line-opacity',1);
}

function deactivateHover(){
	setTimeout( function(){
		map.setFilter("mapillary-hover", ["has","name"]);	
		map2.setFilter("mapillary2-hover", ["has","name"]);	
	}, 200);
	map2.setPaintProperty('mapillary2-hover', 'line-opacity', 0);
	map.setPaintProperty('mapillary-hover', 'line-opacity', 0);
}
</script>

</body>
</html>
